# Отчет 3: Разворачивание инфраструктуры и CI/CD

## 1. Написание Dockerfile для проекта

В `Dockerfile` для проекта на Go был создан образ, который включает в себя все необходимые зависимости: Go, библиотеки и утилиты для работы с базой данных и Redis. Этот Dockerfile также настраивает рабочую директорию, копирует исходный код в контейнер, устанавливает зависимости и настраивает точку входа для приложения.
Ниже приведен сам Dockerfile, доступный по ссылке: [Dockerfile](../backend/Dockerfile).

## 2. Создание docker-compose.yaml для локального запуска (Go + БД + Redis)

В `docker-compose.yaml` был настроен локальный стек для запуска контейнеров с Go-приложением, PostgreSQL и Redis. Этот файл упрощает управление контейнерами, обеспечивая возможность работы всех компонентов в едином окружении с помощью одной команды

```bash
docker-compose up
```

Этот файл можно найти по следующей ссылке: [docker-compose.yml](../docker-compose.yml).

## 3. Настройка автоматических миграций БД

Для автоматической настройки базы данных при запуске приложения были интегрированы миграции с использованием библиотеки `golang-migrate`.
Код для запуска миграций находится в файле [`migrations.go`](../backend/internal/db/migrations.go) При старте приложения происходит подключение к базе данных, выполнение миграций, если они необходимы, и запуск сервера. Миграции хранятся в папке [`migrations`](../backend/migrations), где каждый файл представляет собой отдельную миграцию с SQL-запросами, необходимыми для изменения структуры базы данных.

## 4. Настройка CI/CD

В рамках проекта была настроена система CI/CD с использованием GitHub Actions. CI/CD pipeline автоматически выполняет сборку проекта и тестирование при каждом пуше или pull request в ветки `main` или `master`. В дальнейшем можно будет добавить деплой на сервер, но на текущий момент в pipeline включены только шаги для сборки и тестирования.

### 1. Создание GitHub Actions Workflow

Для автоматизации сборки и тестирования был создан файл конфигурации для GitHub Actions. Этот файл находится в директории `.github/workflows` и называется `go.yml`.

```yaml
name: Go

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.23.1"

      - name: Run tests
        working-directory: ./backend
        run: go test -v ./...

      - name: Build
        working-directory: ./backend
        run: go build ./...
```

### 2. Шаги в конфигурации

- name: Go – имя workflow.

- on: push и on: pull_request – pipeline запускается при пушах в ветки main и master, а также при создании или обновлении pull request в эти ветки.

- jobs – в нашем случае один job с названием test, который выполняет несколько шагов:

- Checkout code: извлечение кода из репозитория.

- Set up Go: настройка окружения с установленной версией Go.

- Run tests: запуск тестов с помощью команды go test.

- Build: сборка приложения с помощью команды go build.

### 3. Ожидаемые результаты

После выполнения этого workflow, GitHub Actions выполнит следующие действия:

- Скачает последний код из репозитория.

- Установит необходимую версию Go.

- Запустит все тесты проекта.

- Выполнит сборку проекта.

После успешного выполнения pipeline, все шаги будут выполнены без ошибок, и проект будет собран. Результаты тестирования будут выведены в логи выполнения workflow. В дальнейшем можно будет добавить деплой на сервер: в случае успешного выполнения сборки и тестирования, код может быть автоматически развернут на сервере (VPS или облачном сервисе).
